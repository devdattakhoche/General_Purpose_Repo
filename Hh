USE static_data
GO

CREATE PROCEDURE dbo.EMEA_PPS_TO_RIC_SQL
AS 
BEGIN
    -- Create the temporary table within the stored procedure scope
    CREATE TABLE #jpmPostTradeID2RicMapping (
        jpm_post_trade_id VARCHAR(255),
        ric VARCHAR(255),
        is_primary INT,
        is_global_primary INT,
        is_primary_jpm_post_trade_id INT
    )

    -- Insert data into the temporary table
    INSERT INTO #jpmPostTradeID2RicMapping (jpm_post_trade_id, ric, is_primary, is_global_primary, is_primary_jpm_post_trade_id)
    SELECT DISTINCT
           map.jpm_post_trade_id,
           map.ric,
           map.is_primary,
           map.is_global_primary,
           map.is_primary_jpm_post_trade_id
    FROM product..GEM_imnt_security_map map
    WHERE map.ric IS NOT NULL 
      AND map.ind_active = 'Y'
      AND (map.is_primary_jpm_post_trade_id = 1
           OR map.is_global_primary = 1 
           OR map.is_primary = 1)
      AND RTRIM(map.jpm_post_trade_id) IS NOT NULL
      AND map.cntry_code IN (SELECT id_ctry_std 
                             FROM static_data..COUNTRY_BY_REGION 
                             WHERE id_region_key IN ('EU', 'EM', 'ZA'))

    -- Create index on jpm_post_trade_id column
    CREATE INDEX #jpmPostTradeID2RicMapping_i1 ON #jpmPostTradeID2RicMapping(jpm_post_trade_id)

    -- Remove duplicates based on specific conditions
    DELETE a
    FROM #jpmPostTradeID2RicMapping a, #jpmPostTradeID2RicMapping b 
    WHERE a.jpm_post_trade_id = b.jpm_post_trade_id
      AND a.is_primary_jpm_post_trade_id != 1
      AND b.is_primary_jpm_post_trade_id = 1

    DELETE a
    FROM #jpmPostTradeID2RicMapping a, #jpmPostTradeID2RicMapping b 
    WHERE a.jpm_post_trade_id = b.jpm_post_trade_id
      AND a.is_primary_jpm_post_trade_id != 1
      AND a.is_global_primary != 1
      AND b.is_global_primary = 1

    -- Truncate existing data in target table
    TRUNCATE TABLE static_data..jpmPostTradeID

    -- Insert into target table
    INSERT INTO static_data..jpmPostTradeID (jpm_post_trade_id, ric)
    SELECT jpm_post_trade_id, ric
    FROM #jpmPostTradeID2RicMapping

    -- Select final results
    SELECT jpm_post_trade_id, ric
    FROM static_data..jpmPostTradeID

    -- Drop the temporary table at the end of the procedure
    DROP TABLE #jpmPostTradeID2RicMapping
END
