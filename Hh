DELIMITER //

CREATE PROCEDURE reference.cursor_example()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE id VARCHAR(100);
    DECLARE get_grips_row CURSOR FOR 
        SELECT exchangeIds
        FROM reference.grips_data_raw 
        WHERE flowType IN ('DMA', 'ALL', 'HIGH_TOUCH', 'NO_TOUCH') 
          AND productType IN ('SWAP','PNOTE');
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    -- Drop the temporary table if it already exists
    DROP TEMPORARY TABLE IF EXISTS `#tempSplitExchangeIds`;

    -- Create the temporary table
    CREATE TEMPORARY TABLE `#tempSplitExchangeIds` (
        exchangeId VARCHAR(20) NULL
    );

    OPEN get_grips_row;

    read_loop: LOOP
        FETCH get_grips_row INTO id;
        IF done THEN
            LEAVE read_loop;
        END IF;

        -- Insert the id into the temporary table
        INSERT INTO `#tempSplitExchangeIds` (exchangeId) VALUES (id);
    END LOOP;

    CLOSE get_grips_row;
END//

DELIMITER ;
